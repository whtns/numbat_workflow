---
title: "R Notebook"
author: "Kevin Stachelek"
output: html_notebook
---

```{r setup, echo = F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```

# load packages

```{r load-lib}
library(tidyverse)
library(Seurat)
library(fs)
library(annotables)
library(rprojroot)
library(seuratTools)
features <- c("gene", "transcript")
proj_dir = rprojroot::find_root(criterion = has_file_pattern("*.Rproj"))

```

# specify 'child' projects

```{r}
child_proj_dirs <- c("~/single_cell_projects/quicklinks/FACS_20170407_dshayler_H_sapiens_proj/",
                "~/single_cell_projects/quicklinks/FACS_20171031_dshayler_H_sapiens_proj/",
               "~/single_cell_projects/quicklinks/FACS_20181001_dshayler_H_sapiens_fetal_proj/",
               "~/single_cell_projects/quicklinks/C1_20151130_HS_H_sapiens_proj/")
```

# load seurat objects from 'child' projects

```{r}

seus <- load_seurat_from_rds(child_proj_dirs)

```

```{r}

# seus <- map2(seus, cc.features, ~map(.x, CellCycleScoring, s.features = .y$s, g2m.features = .y$g2m, set.ident = TRUE))

```

# run seurat batch correction on 'child' projects 

```{r}

corrected_seus <- purrr::map(seus, seuratTools::seurat_batch_correct)

# cluster merged seurat objects
corrected_seus <- map(corrected_seus, seuratTools::seurat_cluster, resolution = seq(0.2, 2.0, by = 0.2))

corrected_seus <- map(corrected_seus, add_rc_cat_meta_to_seu)

purrr::imap(corrected_seus, save_seurat)


```

# add cell cycle scoring to seurat objects

```{r}
corrected_seus <- seuratTools::annotate_cell_cycle(feature_seus)
```

```{r}
map(corrected_seus, Seurat::DimPlot, group.by = "ident")

map(corrected_seus, Seurat::FeaturePlot, features = "S.Score")

map(corrected_seus, Seurat::FeaturePlot, features = "G2M.Score")

```

# add marker genes to seurat objects 

```{r}
corrected_seus <- map(corrected_seus, seuratTools::find_all_markers)
```

```{r}
purrr::map2(corrected_seus, c("gene", "transcript"), save_seurat)
```

# load cell cycle annotated, batch corrected seurat objects

```{r}
corrected_seus <- unlist(load_seurat_from_rds(proj_dir))
```

# run RNA velocity on seurat objects




# filter seurat objects by metadata criteria -- annotated photoreceptors

```{r}

excluded_PRs_seus <- filter_merged_seus(corrected_seus, filter_var = "excluded_because", filter_val = "keep")

excluded_PRs_seus <- reintegrate_seus(excluded_PRs_seus, suffix = "remove_nonPRs")

```


# filter seurat objects by metadata criteria -- low read count

```{r}

high_rc_seus <- filter_merged_seus(corrected_seus, filter_var = "read_count", filter_val = "keep")

high_rc_seus <- reintegrate_seus(high_rc_seus, suffix = "remove_lowrc")

```


## filter seurat objects by both read count and exclusion annotation

```{r}

excluded_PRs_seus <- filter_merged_seus(corrected_seus, filter_var = "excluded_because", filter_val = "keep")

rc_and_excl_seus <- filter_merged_seus(excluded_PRs_seus, filter_var = "read_count", filter_val = "keep")


rc_and_excl_seus <- reintegrate_seus(rc_and_excl_seus, res_low = 0.2, res_hi = 1.6, suffix = "remove_nonPRs_and_lowrc")
```



