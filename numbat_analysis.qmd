---
title: "analysis"
format: html
editor: visual
---

# setup

## load libraries

```{r}

library('tidyverse')
library('fs')
library('readxl')
library(numbat)
library(Seurat)
library(seuratTools)
library(patchwork)
library(msigdbr)
library(glue)

hallmark_gene_sets = msigdbr(species = "Homo sapiens", category = "H")
```

## functions 

```{r}
source("functions.R")

```

## objects 

```{r}
myseus <- list()
output_plots <- list()
mynbs <- list()
```

# wu

```{r}
# wu ------------------------------
study = "wu"
merged_metadata = read_csv(path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/scanpy/merged/metadata.csv"))) %>%
  set_names(c("cell", "sample_id", "merged_leiden")) %>%
  dplyr::mutate(sample_id = str_remove(sample_id, ".h5ad")) %>%
  dplyr::mutate(cell = str_replace(cell, "-", ".")) %>%
  identity()

```

## SRR13884240 numbat ------------------------------

```{r}
sample_id = "SRR13884240"
study = "wu"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_infercnv_numbat_seu.rds"))
# read_regress_save(seu_path)

myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
# 	merged_metadata %>%
# 	dplyr::filter(sample_id == {{sample_id}}) %>%
# 	tibble::column_to_rownames("cell") %>%
# 	identity()
#
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)


output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]]

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)



output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)


mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat"]] <-  safe_plot_numbat(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_numbat_w_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)


output_plots[[sample_id]][["phylo_probability_plot"]] <- output_plots[[sample_id]][["numbat_phylo"]][["result"]] / output_plots[[sample_id]][["numbat_phylo"]][["result"]][[3]][["data"]] %>%
  plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myexpressions <- list(
    'GT_opt %in% c("2a,10b,8a", "2a,10b", "2a") & p_cnv < 0.8 & seg == "2a"',
    'GT_opt %in% c("") & p_cnv > 0.25 & seg == "2a"'
  )

output_plots[[sample_id]][["test0"]] <-  filter_phylo_plot(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9, expressions = myexpressions)

```

## SRR13884241 ------------------------------

```{r}
sample_id = "SRR13884241"
study = "wu"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_infercnv_numbat_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
# 	merged_metadata %>%
# 	dplyr::filter(sample_id == {{sample_id}}) %>%
# 	tibble::column_to_rownames("cell") %>%
# 	identity()
#
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)

output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

# myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)

# mynbs[[sample_id]] <- readRDS("~/single_cell_projects/resources/wu_et_al_proj/output/numbat/SRR13884240_numbat.rds")
# 
# plot_phylo_heatmap(mynbs[[sample_id]])
# 
# 
# mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))
# 
# nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
#   dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
#   tibble::column_to_rownames("cell")
# 
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)
# 
# myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]
# 
# output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)
# 
# output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
#   plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

# myseus[[sample_id]] <- NULL

```

## SRR13884242 numbat ------------------------------

```{r}
sample_id = "SRR13884242"
study = "wu"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_infercnv_numbat_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
# 	merged_metadata %>%
# 	dplyr::filter(sample_id == {{sample_id}}) %>%
# 	tibble::column_to_rownames("cell") %>%
# 	identity()
#
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)



output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)


mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)

output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

# myseus[[sample_id]] <- NULL

```

## SRR13884243 numbat in progress ------------------------------

```{r}
sample_id = "SRR13884243"
study = "wu"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
# 	merged_metadata %>%
# 	dplyr::filter(sample_id == {{sample_id}}) %>%
# 	tibble::column_to_rownames("cell") %>%
# 	identity()
#
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)

output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)

mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
	dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
	tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

# GT_by_cluster_plot <- ggplot(myseus[[sample_id]]@meta.data, aes(x = `gene_snn_res.0.2`, fill = GT_opt)) +
# 	geom_bar(position="fill") +
# 	coord_flip()
#
# cluster_plot <- DimPlot(myseus[[sample_id]], group.by = "gene_snn_res.0.2")
# GT_plot <- DimPlot(myseus[[sample_id]], group.by = "GT_opt")
#
# GT_by_cluster_plot / (cluster_plot + GT_plot)
#
# DimPlot(myseus[[sample_id]], group.by = "type") +    labs(title = sample_id)
#
# # seu <- seu[,!seu$type %in% c("Red Blood Cells")]
#
# DimPlot(myseus[[sample_id]], group.by = "clone_opt")
#
# DimPlot(myseus[[sample_id]], group.by = "gene_snn_res.0.2")

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.2)

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myseus[[sample_id]] <- NULL

```

## SRR13884244 ------------------------------

```{r}
sample_id = "SRR13884244"
study = "wu"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
# 	merged_metadata %>%
# 	dplyr::filter(sample_id == {{sample_id}}) %>%
# 	tibble::column_to_rownames("cell") %>%
# 	identity()
#
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)

output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)


mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)


output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()


output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myseus[[sample_id]] <- NULL

```

## SRR13884245 numbat ------------------------------

```{r}
sample_id = "SRR13884245"
study = "wu"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
# 	merged_metadata %>%
# 	dplyr::filter(sample_id == {{sample_id}}) %>%
# 	tibble::column_to_rownames("cell") %>%
# 	identity()
#
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)

output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)

mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)


output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)


myseus[[sample_id]] <- NULL

```

## SRR13884246 numbat ------------------------------

```{r}
sample_id = "SRR13884246"
study = "wu"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_infercnv_numbat_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
# 	merged_metadata %>%
# 	dplyr::filter(sample_id == {{sample_id}}) %>%
# 	tibble::column_to_rownames("cell") %>%
# 	identity()
#
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)

output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]


myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)

mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)

output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myseus[[sample_id]] <- NULL

```

## SRR13884247 numbat ------------------------------

```{r}
sample_id = "SRR13884247"
study = "wu"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
# 	merged_metadata %>%
# 	dplyr::filter(sample_id == {{sample_id}}) %>%
# 	tibble::column_to_rownames("cell") %>%
# 	identity()
#
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)

output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)


mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)


output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myseus[[sample_id]] <- NULL

```

## SRR13884248 numbat ------------------------------

```{r}
sample_id = "SRR13884248"
study = "wu"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_infercnv_numbat_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
# 	merged_metadata %>%
# 	dplyr::filter(sample_id == {{sample_id}}) %>%
# 	tibble::column_to_rownames("cell") %>%
# 	identity()
#
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)

output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])


mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)

output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()

# saveRDS(myseus[[sample_id]], seu_path)

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myseus[[sample_id]] <- NULL

```

## SRR13884249 numbat ------------------------------

```{r}
sample_id = "SRR13884249"
study = "wu"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_infercnv_numbat_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
# 	merged_metadata %>%
# 	dplyr::filter(sample_id == {{sample_id}}) %>%
# 	tibble::column_to_rownames("cell") %>%
# 	identity()
#
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)



output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)


mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)

output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myseus[[sample_id]] <- NULL

```

# yang------------------------------

```{r}

study = "yang"
merged_metadata = read_csv(path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/scanpy/merged/metadata.csv"))) %>%
  set_names(c("cell", "sample_id", "merged_leiden")) %>%
  dplyr::mutate(sample_id = str_remove(sample_id, ".h5ad")) %>%
  dplyr::mutate(cell = str_replace(cell, "-", ".")) %>%
  identity()
```

## SRR14800534 numbat ------------------------------

```{r}
sample_id = "SRR14800534"
study = "yang"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_infercnv_numbat_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
# 	merged_metadata %>%
# 	dplyr::filter(sample_id == {{sample_id}}) %>%
# 	tibble::column_to_rownames("cell") %>%
# 	identity()
#
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)



output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)


mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)

output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myseus[[sample_id]] <- NULL

```

## SRR14800536 numbat ------------------------------

```{r}
sample_id = "SRR14800536"
study = "yang"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_infercnv_numbat_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
# 	merged_metadata %>%
# 	dplyr::filter(sample_id == {{sample_id}}) %>%
# 	tibble::column_to_rownames("cell") %>%
# 	identity()
#
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)



output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)


mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)

output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myseus[[sample_id]] <- NULL

```

## SRR14800537 numbat ------------------------------

```{r}
sample_id = "SRR14800537"
study = "yang"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_infercnv_numbat_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
# 	merged_metadata %>%
# 	dplyr::filter(sample_id == {{sample_id}}) %>%
# 	tibble::column_to_rownames("cell") %>%
# 	identity()
#
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)



output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)


mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)

output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myseus[[sample_id]] <- NULL

```

## SRR14800539 numbat ------------------------------

```{r}
sample_id = "SRR14800539"
study = "yang"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_infercnv_numbat_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
# 	merged_metadata %>%
# 	dplyr::filter(sample_id == {{sample_id}}) %>%
# 	tibble::column_to_rownames("cell") %>%
# 	identity()
#
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)



output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)


mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)

output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myseus[[sample_id]] <- NULL

```

## SRR14800540 numbat ------------------------------

```{r}
sample_id = "SRR14800540"
study = "yang"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_infercnv_numbat_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
# 	merged_metadata %>%
# 	dplyr::filter(sample_id == {{sample_id}}) %>%
# 	tibble::column_to_rownames("cell") %>%
# 	identity()
#
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)



output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)


mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)

output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myseus[[sample_id]] <- NULL

```

## SRR14800541 numbat ------------------------------
```{r}
sample_id = "SRR14800541"
study = "yang"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_infercnv_numbat_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
# 	merged_metadata %>%
# 	dplyr::filter(sample_id == {{sample_id}}) %>%
# 	tibble::column_to_rownames("cell") %>%
# 	identity()
#
# myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)



output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)


mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)

output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myseus[[sample_id]] <- NULL

```

# field ------------------------------

```{r}
study = "field"
merged_metadata = read_csv(path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/scanpy/merged/metadata.csv"))) %>%
  set_names(c("cell", "sample_id", "merged_leiden")) %>%
  dplyr::mutate(sample_id = str_remove(sample_id, ".h5ad")) %>%
  dplyr::mutate(cell = str_replace(cell, "-", ".")) %>%
  identity()
```

## SRR17960481 numbat ------------------------------
```{r}
sample_id = "SRR17960481"
study = "field"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_infercnv_numbat_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

merged_metadata_transfer <-
	merged_metadata %>%
	dplyr::filter(sample_id == {{sample_id}}) %>%
	tibble::column_to_rownames("cell") %>%
	identity()

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)



output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)


mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)

output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myseus[[sample_id]] <- NULL

```

## SRR17960482 numbat ------------------------------

```{r}
sample_id = "SRR17960482"
study = "field"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_infercnv_numbat_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

merged_metadata_transfer <-
	merged_metadata %>%
	dplyr::filter(sample_id == {{sample_id}}) %>%
	tibble::column_to_rownames("cell") %>%
	identity()

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)



output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)


mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)

output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myseus[[sample_id]] <- NULL

```

## SRR17960483 numbat ------------------------------
```{r}
sample_id = "SRR17960483"
study = "field"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_infercnv_numbat_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

merged_metadata_transfer <-
	merged_metadata %>%
	dplyr::filter(sample_id == {{sample_id}}) %>%
	tibble::column_to_rownames("cell") %>%
	identity()

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)



output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)


mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)

output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myseus[[sample_id]] <- NULL

```

## SRR17960484 numbat ------------------------------
```{r}
sample_id = "SRR17960484"
study = "field"
seu_path = path(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/seurat/{sample_id}_infercnv_numbat_seu.rds"))
# read_regress_save(seu_path)
myseus[[sample_id]] <- readRDS(seu_path)

# merged_metadata_transfer <-
	merged_metadata %>%
	dplyr::filter(sample_id == {{sample_id}}) %>%
	tibble::column_to_rownames("cell") %>%
	identity()

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], merged_metadata_transfer)



output_plots[[sample_id]][["dimplot"]] <- DimPlot(myseus[[sample_id]], group.by = c("merged_leiden", "gene_snn_res.0.2"))

output_plots[[sample_id]][["merged_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "merged_leiden", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["sample_marker"]] <- plot_markers(myseus[[sample_id]], metavar = "gene_snn_res.0.2", marker_method = "presto", return_plotly = FALSE)

output_plots[[sample_id]][["merged_marker"]] + output_plots[[sample_id]][["sample_marker"]]

myseus[[sample_id]] <- annotate_seu_with_rb_subtype_gene_expression(myseus[[sample_id]])

# saveRDS(myseus[[sample_id]], seu_path)


mynbs[[sample_id]] <- readRDS(glue("~/single_cell_projects/resources/{study}_et_al_proj/output/numbat/{sample_id}_numbat.rds"))

nb_meta <- mynbs[[sample_id]][["clone_post"]][,c("cell", "clone_opt", "GT_opt")] %>%
  dplyr::mutate(cell = str_replace(cell, "-", "\\.")) %>%
  tibble::column_to_rownames("cell")

myseus[[sample_id]] <- Seurat::AddMetaData(myseus[[sample_id]], nb_meta)

myannot = mynbs[[sample_id]]$clone_post[,c("cell", "GT_opt")]

output_plots[[sample_id]][["numbat_phylo"]] <-  safe_plot_phylo(mynbs[[sample_id]], myseus[[sample_id]], myannot, sample_id, clone_bar = FALSE, p_min = 0.9)

output_plots[[sample_id]][["phylo_probability_plot"]] <- ggplotify::as.ggplot(output_plots[[sample_id]][["numbat_phylo"]][["result"]]) / output_plots[[sample_id]][["numbat_phylo"]][["result"]] %>%
  plot_variability_at_SCNA()

output_plots[[sample_id]][["clone_distribution"]] <- 
  plot_distribution_of_clones_across_clusters(myseus[[sample_id]], sample_id)

myseus[[sample_id]] <- NULL

```

# gather objects ------------------------------

## clone distribution plots

```{r}
pdf("results/clone_distribution_plots.pdf")
transpose(output_plots)[["clone_distribution"]]
dev.off()
browseURL("results/clone_distribution_plots.pdf")
```

## phylo probability plots

```{r}

pdf("results/phylo_probability_plots.pdf")
transpose(output_plots)[["phylo_probability_plot"]]
dev.off()
browseURL("results/phylo_probability_plots.pdf")
```

## subtype marker plots 

```{r}
subtype_hallmarks <-
	list(gp1 = c(
		"HALLMARK_INTERFERON_GAMMA_RESPONSE", "HALLMARK_INTERFERON_ALPHA_RESPONSE",
		"HALLMARK_ALLOGRAFT_REJECTION", "HALLMARK_INFLAMMATORY_RESPONSE",
		"HALLMARK_COMPLEMENT", "HALLMARK_OXIDATIVE_PHOSPHORYLATION",
		"HALLMARK_FATTY_ACID_METABOLISM", "HALLMARK_PEROXISOME", "HALLMARK_BILE_ACID_METABOLISM",
		"HALLMARK_PROTEIN_SECRETION"
	), gp2 = c(
		"HALLMARK_G2M_CHECKPOINT",
		"HALLMARK_E2F_TARGETS", "HALLMARK_MYC_TARGETS_V1", "HALLMARK_MITOTIC_SPINDLE",
		"HALLMARK_MYC_TARGETS_V2"
	)) %>%
	unlist()

# plot rb subtype expression (liu et al. 2020)
plot_rb_subtype_expression <- function(seu, seu_name, subtype_hallmarks){

	myfeatures <- c("exprs_gp1", "exprs_gp2", c(subtype_hallmarks))
	featureplots <- FeaturePlot(seu, myfeatures, combine = FALSE)

	featureplots <- map(featureplots, ~(.x + labs(subtitle = seu_name))) %>%
		set_names(myfeatures)

}

subtype_expression_plots <- imap(myseus, plot_rb_subtype_expression, subtype_hallmarks) %>%
	purrr::transpose()

pdf("results/subtype_hallmark_plots.pdf")
subtype_expression_plots
dev.off()

browseURL("results/subtype_hallmark_plots.pdf")
```

## marker plots 
```{r}
merged_marker_plots <- map(output_plots, "merged_marker")
sample_marker_plots <- map(output_plots, "sample_marker")


pdf("results/marker_plots.pdf", width = 10)
map2(merged_marker_plots, sample_marker_plots, wrap_plots)
dev.off()

browseURL("results/marker_plots.pdf")
```

## dimplots
```{r}
pdf("results/dimplots.pdf", width = 10)
map(output_plots, "dimplot")
dev.off()

browseURL("results/dimplots.pdf")
```

## markers of interest ------------------------------
```{r}
checked_cluster_markers <-
	list(
"0" = c("PCLAF", "TYMS"),
"1" = c("RCVRN"),
"2" = c("TOP2A", "NUSAP1", "RRM2"),
"4" = c("UBE2C", "ARL6IP1", "PTTG1"),
"5" = c("EPB41L4A-AS1", "HSPB1", "DNAJB1"),
"6" = c("GNB3", "PDE6H"),
# "7" = c("B2M", "APOE", "FTL", "VIM", "LGALS1"),
"8" = c("HIST1H4C")
# "9" = c("GNGT1", "ROM1", "GNAT1")
)

plot_markers_by_cell_cycle <- plot_cluster_markers_by_cell_type <- function(seu, checked_cluster_markers){
	cluster_plots <- map(checked_cluster_markers, ~VlnPlot(seu, features = .x, group.by = "Phase"))

	cluster_plots <- map2(cluster_plots, names(checked_cluster_markers), ~(.x + labs(subtitle = .y)))

	return(cluster_plots)

}

cell_cycle_plots <- map(myseus, plot_markers_by_cell_cycle, checked_cluster_markers)

pdf("results/cell_cycle_markers.pdf")
for (i in names(checked_cluster_markers)){
	for(j in cell_cycle_plots){
		print(j[i])
	}
}
dev.off()

browseURL("results/cell_cycle_markers.pdf")

```

# common marker plots 2

```{r}

checked_marker_vector <- map_chr(checked_cluster_markers, 1)

plot_feature_across_seus <- function(seu, seu_title, myvar){

	varplot <- seu %>%
		FeaturePlot(features = myvar)

	dimplot <- DimPlot(seu, group.by = "gene_snn_res.0.2")

	phase_plot <- DimPlot(seu, group.by = "Phase")

	(varplot | (phase_plot / dimplot)) +
		plot_annotation(title = seu_title)

	# mypatch = wrap_plots(varplot, dimplot, phase_plot, nrow = 1) +
	# 	plot_annotation(title = seu_title)
}

common_marker_plots <- imap(myseus, plot_feature_across_seus, checked_marker_vector)

pdf("results/common_marker_plots2.pdf", height = 12, width = 16)
common_marker_plots
dev.off()

browseURL("results/common_marker_plots2.pdf")
```

# check individual sample

```{r}
compplot_feature_and_clusters <- function(seu, feature){
	fp <- FeaturePlot(seu, feature)

	cp <- DimPlot(seu, group.by = "Phase")

	dp1 <- DimPlot(seu, group.by = c("gene_snn_res.0.15", "merged_leiden"))

	mypatch <- wrap_plots(fp, cp, nrow = 1) / dp1

	return(mypatch)
}


```
